name: Daily Stock Analysis

on:
  # Run twice daily:
  # - 8:00 AM IST (2:30 AM UTC) - Morning session
  # - 6:00 PM IST (12:30 PM UTC) - Evening session
  schedule:
    - cron: '30 2 * * *'   # 8 AM IST
    - cron: '30 12 * * *'  # 6 PM IST

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      session:
        description: 'Session (AM/PM/auto/next)'
        required: false
        default: 'next'

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine session
        id: session
        run: |
          INPUT_SESSION="${{ github.event.inputs.session }}"

          # For scheduled runs or if input is auto, detect based on UTC hour
          if [ -z "$INPUT_SESSION" ] || [ "$INPUT_SESSION" == "auto" ]; then
            HOUR=$(date -u +%H)
            # Before 8 UTC (1:30 PM IST) is AM session, after is PM session
            if [ $HOUR -lt 8 ]; then
              echo "session=AM" >> $GITHUB_OUTPUT
            else
              echo "session=PM" >> $GITHUB_OUTPUT
            fi
          else
            # Use the provided input (AM, PM, or next)
            echo "session=$INPUT_SESSION" >> $GITHUB_OUTPUT
          fi
          echo "Determined session: $(cat $GITHUB_OUTPUT | grep session)"

      - name: Ensure output directory exists
        run: mkdir -p output

      - name: Run Reddit Stock Analyzer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # The main.py script handles 'next' session detection and auto-generates comparison for PM
          set -e  # Exit on error
          python main.py --session ${{ steps.session.outputs.session }}
          echo "Script completed successfully"

      - name: List generated files
        run: |
          echo "=== Output folder contents ==="
          ls -la output/ || echo "Output folder does not exist"
          echo ""
          echo "=== Report files ==="
          ls -la output/report_*.txt 2>/dev/null || echo "No report files found"
          echo ""
          echo "=== Comparison files ==="
          ls -la output/comparison_*.json 2>/dev/null || echo "No comparison files found"

      - name: Commit and push new reports
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add report files and comparison files (not raw data)
          git add output/report_*.txt 2>/dev/null || echo "No report files to add"
          git add output/comparison_*.json 2>/dev/null || echo "No comparison files to add"

          # Show what's staged
          echo "=== Staged files ==="
          git diff --staged --name-only

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new reports to commit"
          else
            git commit -m "${{ steps.session.outputs.session }} report: $(date +'%Y-%m-%d %H:%M') UTC

            Automated analysis from GitHub Actions"
            git push
          fi

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.session.outputs.session }}-report-${{ github.run_number }}
          path: |
            output/report_*.txt
            output/comparison_*.json
          retention-days: 30
